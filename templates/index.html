<!DOCTYPE html>
<html>
<head>
    <title>Monument Group Admin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #f4f7f6; }
        #map { flex: 2; height: 100%; }
        #sidebar { flex: 1; padding: 20px; overflow-y: auto; background: white; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .box { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; padding: 10px; border-radius: 4px; border: none; font-weight: bold; width: 100%; }
        .btn-add { background: #28a745; color: white; margin-top: 10px; }
        .btn-save { background: #007bff; color: white; margin-top: 20px; font-size: 16px; }
        .btn-danger { background: #dc3545; color: white; margin-top: 5px; }
        .loc-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <h2>Group Manager</h2>
    
    <div class="box">
        <label>Select Monument Group:</label>
        <select id="group-selector" onchange="loadGroup()">
            <option value="new">-- Create New Group --</option>
        </select>
        <input type="text" id="group-name" placeholder="Group Name (e.g. London Highlights)">
        <input type="hidden" id="group-id">
    </div>

    <div class="box" style="border-left: 4px solid #007bff;">
        <h3>Add Point to Group</h3>
        <p style="font-size: 12px; color: #666;">Click map to set Lat/Lng</p>
        <input type="hidden" id="edit-loc-id">
        <input type="text" id="loc-name" placeholder="Location Name">
        <div style="display:flex; gap:5px;">
            <input type="text" id="lat" placeholder="Lat" readonly>
            <input type="text" id="lng" placeholder="Lng" readonly>
        </div>
        <textarea id="loc-question" placeholder="Quiz Question"></textarea>
        <input type="file" id="loc-image" onchange="encodeImage(this)">
        <button class="btn-add" onclick="pushLocationToList()">Push to List</button>
    </div>

    <h3>Points in this Group:</h3>
    <div id="loc-list-container"></div>

    <button class="btn-save" onclick="syncWithServer()">Save Entire Group to DB</button>
    <button class="btn-danger" id="del-group-btn" style="display:none;" onclick="deleteGroup()">Delete Group</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let activeMarker = null;
    let existingMarkers = L.featureGroup().addTo(map);
    let allGroups = [];
    let currentLocations = []; 
    let tempBase64 = null;

    // 1. Map Click: Handle new point placement
    map.on('click', (e) => {
        document.getElementById('lat').value = e.latlng.lat.toFixed(6);
        document.getElementById('lng').value = e.latlng.lng.toFixed(6);
        if (activeMarker) activeMarker.setLatLng(e.latlng);
        else activeMarker = L.marker(e.latlng).addTo(map);
    });

    // 2. Encode Image to Base64
    function encodeImage(input) {
        const reader = new FileReader();
        reader.onload = (e) => { tempBase64 = e.target.result; };
        if(input.files[0]) reader.readAsDataURL(input.files[0]);
    }

    // 3. Push location to local list
    function pushLocationToList() {
        const name = document.getElementById('loc-name').value;
        const lat = document.getElementById('lat').value;
        if(!name || !lat) return alert("Fill name and click map!");

        const loc = {
            id: document.getElementById('edit-loc-id').value || null,
            name: name,
            lat: lat,
            lng: document.getElementById('lng').value,
            question: document.getElementById('loc-question').value,
            image_data: tempBase64,
            image_url: document.getElementById('edit-loc-id').value ? currentLocations.find(l=>l.id==document.getElementById('edit-loc-id').value).image_url : null
        };

        const idx = currentLocations.findIndex(l => l.id === loc.id && loc.id !== null);
        if(idx > -1) currentLocations[idx] = loc;
        else {
            loc.id = Date.now().toString();
            currentLocations.push(loc);
        }

        renderListAndMarkers();
        clearLocForm();
    }

    function renderListAndMarkers() {
        const container = document.getElementById('loc-list-container');
        container.innerHTML = '';
        existingMarkers.clearLayers();

        currentLocations.forEach(loc => {
            // List item
            const div = document.createElement('div');
            div.className = 'loc-item';
            div.innerHTML = `<span>${loc.name}</span> <div><button onclick="editLocalLoc('${loc.id}')">✏️</button><button onclick="removeLocalLoc('${loc.id}')">❌</button></div>`;
            container.appendChild(div);

            // Map marker
            const m = L.marker([loc.lat, loc.lng]).addTo(existingMarkers);
            m.bindPopup(`<b>${loc.name}</b>`);
        });
    }

    // 4. Server Sync
    async function syncWithServer() {
        const payload = {
            id: document.getElementById('group-id').value || null,
            monument_name: document.getElementById('group-name').value,
            locations: currentLocations
        };
        const res = await fetch('/admin/monuments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        if(res.ok) { alert("Group Saved!"); location.reload(); }
    }

    // 5. Load Group
    async function fetchGroups() {
        const res = await fetch('/admin/monuments');
        allGroups = await res.json();
        const sel = document.getElementById('group-selector');
        allGroups.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g._id; opt.textContent = g.monument_name;
            sel.appendChild(opt);
        });
    }

    function loadGroup() {
        const gid = document.getElementById('group-selector').value;
        if(gid === 'new') return location.reload();
        
        const group = allGroups.find(g => g._id === gid);
        document.getElementById('group-id').value = group._id;
        document.getElementById('group-name').value = group.monument_name;
        document.getElementById('del-group-btn').style.display = 'block';
        currentLocations = group.locations;
        renderListAndMarkers();
    }

    function editLocalLoc(id) {
        const loc = currentLocations.find(l => l.id === id);
        document.getElementById('edit-loc-id').value = loc.id;
        document.getElementById('loc-name').value = loc.name;
        document.getElementById('lat').value = loc.lat;
        document.getElementById('lng').value = loc.lng;
        document.getElementById('loc-question').value = loc.question;
        map.setView([loc.lat, loc.lng], 12);
    }

    function removeLocalLoc(id) {
        currentLocations = currentLocations.filter(l => l.id !== id);
        renderListAndMarkers();
    }

    function clearLocForm() {
        document.getElementById('edit-loc-id').value = '';
        document.getElementById('loc-name').value = '';
        document.getElementById('lat').value = '';
        document.getElementById('lng').value = '';
        document.getElementById('loc-question').value = '';
        document.getElementById('loc-image').value = '';
        tempBase64 = null;
    }

    fetchGroups();
</script>
</body>
</html>